#!/bin/sh

set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

NPM_AUTH=$(cat $ENV_DIR/NEXUS_NPM_AUTH)
NPM_EMAIL=$(cat $ENV_DIR/NEXUS_NPM_EMAIL)
NPM_REGISTRY=$(cat $ENV_DIR/NEXUS_NPM_REGISTRY)

echo "Creating an npm account for '$NPM_EMAIL' to registry '$NPM_REGISTRY'"
printf "email=$NPM_EMAIL
_auth=$NPM_AUTH
always-auth=true
$NPM_REGISTRY
" > ~/.npmrc

echo "Enabling workspaces in yarn"
yarn config set workspaces-experimental true

echo "Adding lerna globally"
yarn add global lerna

echo "Adding yarn global bin dir to path"
export PATH="$PATH:$(yarn global dir)/node_modules/.bin"

cd $BUILD_DIR
echo "Lerna bootstrap"
lerna bootstrap

echo "Building all packages in the monorepo..."
lerna run build --stream

echo "Setting up `static.json`"
echo <<'EOF' > static.json
{
  "root": "packages/apex/build/",
  "clean_urls": false,
  "routes": {
    "/**": "index.html"
  }
}

EOF;

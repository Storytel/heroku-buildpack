#!/bin/sh

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

YARN_VERSION="1.3.2"
NPM_AUTH=$(cat $ENV_DIR/NEXUS_NPM_AUTH)
NPM_EMAIL=$(cat $ENV_DIR/NEXUS_NPM_EMAIL)
NPM_REGISTRY=$(cat $ENV_DIR/NEXUS_NPM_REGISTRY)

echo "Creating an npm account for '$NPM_EMAIL' to registry '$NPM_REGISTRY'"
printf "email=$NPM_EMAIL
_auth=$NPM_AUTH
always-auth=true
$NPM_REGISTRY
" > ~/.npmrc

yarn config set workspaces-experimental true
yarn add global lerna
lerna bootstrap
lerna run build --stream

echo "Setting up `static.json`"
echo <<'EOF' > static.json
{
  "root": "build/",
  "clean_urls": false,
  "routes": {
    "/**": "index.html"
  }
}
EOF;

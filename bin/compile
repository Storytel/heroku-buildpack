#!/bin/bash -x

set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

NPM_AUTH=$(cat $ENV_DIR/NEXUS_NPM_AUTH)
NPM_EMAIL=$(cat $ENV_DIR/NEXUS_NPM_EMAIL)
NPM_REGISTRY=$(cat $ENV_DIR/NEXUS_NPM_REGISTRY)

echo "Creating an npm account for '$NPM_EMAIL' to registry '$NPM_REGISTRY'"
printf "email=$NPM_EMAIL
_auth=$NPM_AUTH
always-auth=true
$NPM_REGISTRY
" > ~/.npmrc

echo "Setting up static.json"
cd $BUILD_DIR
cat << EOF > static.json
{
  "root": "packages/apex/build/",
  "clean_urls": false,
  "routes": {
    "/**": "index.html"
  }
}
EOF

echo "CATTTING"
cat $BUILD_DIR/static.json

echo "Enabling workspaces in yarn"
yarn config set workspaces-experimental true

cd $BUILD_DIR
echo "Installing devDependencies"
yarn --production=false

echo "Lerna bootstrap"
$BUILD_DIR/node_modules/.bin/lerna bootstrap

echo "Building all packages in the monorepo..."
$BUILD_DIR/node_modules/.bin/lerna run build --stream
